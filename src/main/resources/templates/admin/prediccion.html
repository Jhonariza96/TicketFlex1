<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predicción Ticketflex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">

    <style>
        .form-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(121, 117, 117, 0.1);
            background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
        }

        .form-title {
            color: #0d6efd;
            margin-bottom: 25px;
            text-align: center;
        }

        .required-field::after {
            content: " *";
            color: red;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875em;
        }

        .prediction-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .progress {
            height: 25px;
            margin-top: 10px;
        }

        .progress-bar {
            transition: width 1s ease-in-out;
        }

        .confidence-high {
            color: #28a745;
            font-weight: bold;
        }

        .confidence-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .confidence-low {
            color: #dc3545;
            font-weight: bold;
        }

        .factors-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .positive-factors,
        .negative-factors {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
        }

        .positive-factors {
            background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
            border-left: 4px solid #4CAF50;
        }

        .negative-factors {
            background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
            border-left: 4px solid #f44336;
        }

        .recommendations {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
            border-left: 4px solid #2196F3;
            border-radius: 8px;
        }

        .submitted-data {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, var(--bg-color), var(--bg-secondary));
            border-radius: 8px;
        }

        /* Estilos para el autocompletado */
        #btnBuscar {
            transition: all 0.3s ease;
        }

        #btnBuscar:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-top;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
        }

        /* Estilos para las sugerencias */
        .action-suggestions .list-group-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-suggestions .list-group-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
    </style>
</head>

<body>

    <div class="container form-container">
        <!-- Botón del dashboard -->
        <a th:href="@{/admin/dashboard}" class="btn btn-primary mb-3">Volver al Dashboard</a>
        <h2 class="form-title">Predicción de Compra de Boletas</h2>

        <!-- Campo de búsqueda por ID -->
        <div class="mb-4 p-3 border rounded">
            <h5>Buscar cliente existente</h5>
            <div class="mb-3">
                <label for="buscarId" class="form-label">Ingrese ID del cliente</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="buscarId" min="1" placeholder="Ej: 8">
                    <button class="btn btn-primary" type="button" id="btnBuscar">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
                <div id="idError" class="error-message"></div>
            </div>
        </div>

        <!-- Formulario de predicción -->
        <form id="clienteForm" th:action="@{/admin/prediccion/predecir}" method="post">
            <!-- ID Cliente -->
            <div class="mb-3">
                <label for="idCliente" class="form-label required-field">ID del Cliente</label>
                <input type="number" class="form-control" id="idCliente" name="idCliente" min="1" required
                    th:value="${ticketflexData.idCliente}">
                <div class="error-message" id="idClienteError"></div>
            </div>

            <!-- Edad -->
            <div class="mb-3">
                <label for="edad" class="form-label required-field">Edad</label>
                <input type="number" class="form-control" id="edad" name="edad" min="18" max="100" required
                    th:value="${ticketflexData.edad}">
                <div class="error-message" id="edadError"></div>
            </div>

            <!-- Género -->
            <div class="mb-3">
                <label for="genero" class="form-label required-field">Género</label>
                <select class="form-select" id="genero" name="genero" required>
                    <option value="" selected disabled>Seleccione una opción</option>
                    <option th:each="genero : ${generos}" th:value="${genero}" th:text="${genero}"
                        th:selected="${ticketflexData.genero == genero}"></option>
                </select>
                <div class="error-message" id="generoError"></div>
            </div>

            <!-- Total Eventos Asistidos -->
            <div class="mb-3">
                <label for="totalEventosAsistidos" class="form-label required-field">Total Eventos Asistidos</label>
                <input type="number" class="form-control" id="totalEventosAsistidos" name="totalEventosAsistidos"
                    min="0" required th:value="${ticketflexData.totalEventosAsistidos}">
                <div class="error-message" id="eventosError"></div>
            </div>

            <!-- Género Favorito -->
            <div class="mb-3">
                <label for="generoFavorito" class="form-label required-field">Género Favorito</label>
                <select class="form-select" id="generoFavorito" name="generoFavorito" required>
                    <option value="" selected disabled>Seleccione una opción</option>
                    <option th:each="g : ${generosMusicales}" th:value="${g}" th:text="${g}"
                        th:selected="${ticketflexData.generoFavorito == g}"></option>
                </select>
                <div class="error-message" id="generoFavoritoError"></div>
            </div>

            <!-- Promedio Gasto Histórico -->
            <div class="mb-3">
                <label for="promedioGastoHistorico" class="form-label required-field">Promedio Gasto Histórico
                    (USD)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="promedioGastoHistorico" name="promedioGastoHistorico"
                        min="0" step="0.01" required th:value="${ticketflexData.promedioGastoHistorico}">
                </div>
                <div class="error-message" id="promedioError"></div>
            </div>

            <!-- Nuevo Género Concierto -->
            <div class="mb-3">
                <label for="nuevoGeneroConcierto" class="form-label required-field">Nuevo Género del Concierto</label>
                <select class="form-select" id="nuevoGeneroConcierto" name="nuevoGeneroConcierto" required>
                    <option value="" selected disabled>Seleccione una opción</option>
                    <option th:each="g : ${generosMusicales}" th:value="${g}" th:text="${g}"
                        th:selected="${ticketflexData.nuevoGeneroConcierto == g}"></option>
                </select>
                <div class="error-message" id="nuevoGeneroError"></div>
            </div>

            <!-- Nuevo Precio -->
            <div class="mb-3">
                <label for="nuevoPrecio" class="form-label required-field">Precio del Nuevo Evento (USD)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" id="nuevoPrecio" name="nuevoPrecio" min="0" step="0.01"
                        required th:value="${ticketflexData.nuevoPrecio}">
                </div>
                <div class="error-message" id="nuevoPrecioError"></div>
            </div>

            <!-- Descuento Disponible -->
            <div class="mb-3">
                <label class="form-label required-field">¿Hay Descuento Disponible?</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="descuentoDisponible" id="descuentoSi" value="1"
                        th:checked="${ticketflexData.descuentoDisponible == 1}">
                    <label class="form-check-label" for="descuentoSi">Sí</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="descuentoDisponible" id="descuentoNo" value="0"
                        th:checked="${ticketflexData.descuentoDisponible == 0}">
                    <label class="form-check-label" for="descuentoNo">No</label>
                </div>
                <div class="error-message" id="descuentoError"></div>
            </div>
            <!-- Botones -->
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-primary" type="submit">Predecir Asistencia</button>
                <button class="btn btn-outline-secondary" type="reset">Limpiar Formulario</button>
            </div>
        </form>
        <!-- Resultados de la predicción -->
        <div th:if="${showResult}" class="mt-4">
            <h3>Resultado de la Predicción:</h3>
            <div class="card">
                <div class="card-body text-white">
                    <p><strong>¿Asistirá al concierto?</strong> <span
                            th:text="${prediccion == '1' ? 'Sí' : 'No'}"></span></p>
                    <p><strong>Confianza:</strong> <span th:text="${confianza}"></span></p>

                    <div class="progress mt-3">
                        <div id="predictionBar" class="progress-bar" role="progressbar"
                            th:classappend="${confianzaValue >= 85} ? 'bg-success' : (${confianzaValue >= 60} ? 'bg-warning' : 'bg-danger')"
                            th:attr="style='width:' + ${confianzaValue} + '%'">
                        </div>
                    </div>

                    <div class="mt-3 text-white">
                        <span th:if="${confianzaValue >= 85}">✅ Alta confianza en la predicción</span>
                        <span th:if="${confianzaValue >= 60 && confianzaValue < 85}">⚠ Confianza moderada</span>
                        <span th:if="${confianzaValue < 60}">❌ Baja confianza</span>
                    </div>
                </div>
            </div>

            <!-- Datos enviados -->
            <div class="submitted-data mt-4">
                <h4>📊 Datos Utilizados</h4>
                <ul class="list-group">
                    <li class="list-group-item"><strong>ID Cliente:</strong> <span
                            th:text="${ticketflexData.idCliente}"></span></li>
                    <li class="list-group-item"><strong>Edad:</strong> <span th:text="${ticketflexData.edad}"></span>
                    </li>
                    <li class="list-group-item"><strong>Género:</strong> <span
                            th:text="${ticketflexData.genero}"></span></li>
                    <li class="list-group-item"><strong>Total eventos asistidos:</strong> <span
                            th:text="${ticketflexData.totalEventosAsistidos}"></span></li>
                    <li class="list-group-item"><strong>Género favorito:</strong> <span
                            th:text="${ticketflexData.generoFavorito}"></span></li>
                    <li class="list-group-item"><strong>Promedio gasto histórico:</strong> $<span
                            th:text="${#numbers.formatDecimal(ticketflexData.promedioGastoHistorico, 1, 2)}"></span>
                    </li>
                    <li class="list-group-item"><strong>Nuevo género del concierto:</strong> <span
                            th:text="${ticketflexData.nuevoGeneroConcierto}"></span></li>
                    <li class="list-group-item"><strong>Nuevo precio:</strong> $<span
                            th:text="${#numbers.formatDecimal(ticketflexData.nuevoPrecio, 1, 2)}"></span></li>
                    <li class="list-group-item"><strong>Descuento disponible:</strong> <span
                            th:text="${ticketflexData.descuentoDisponible ? 'Sí' : 'No'}"></span></li>
                </ul>
            </div>
        </div>

        <!-- Toast para notificaciones -->
        <div class="toast align-items-center text-white bg-success" id="toastNotificacion" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMensaje"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script th:src="@{/js/prediccion.js}" defer></script>
</body>

</html>